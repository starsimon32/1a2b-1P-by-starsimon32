<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>1A2B 完整教學6 SPA</title>
<style>
button { margin: 2px; }
input { width: 40px; text-align: center; }
</style>
</head>

<body onload="renderStartPage()">

<div id="app"></div>

<script>
/* ========= 全域狀態 ========= */
const state = {
    playerName: "",
    digit: 4,
    fakeInput: "",
    useRepeat: true,   // 修正大小寫
    low: "0",
    high: "9"
};

/* ========= 可用字元集合 ========= */
const allowedChars = "0123456789abcdefghijklmnopqrstuvwxyz";

/* ========= 畫面 1 ========= */
function renderStartPage() {
    document.getElementById("app").innerHTML = `
        <h2>開始畫面</h2>

        <label>玩家名稱：
            <input id="nameInput" placeholder="輸入名字" value="${state.playerName}">
        </label>
        <br><br>

        <label>遊戲位數：
            <input id="digitInput" type="number" value="${state.digit}">
        </label>
        <br><br>

        <label>
            是否允許重複：
            <input type="checkbox" id="useRepeat" ${state.useRepeat ? "checked" : ""}>
        </label>
        <br><br>

        <label>
            最低位：
            <input id="lowInput" value="${state.low}" maxlength="1">
            <button onclick="decrement('lowInput')">↓</button>
            <button onclick="increment('lowInput')">↑</button>
        </label>
        <br><br>

        <label>
            最高位：
            <input id="highInput" value="${state.high}" maxlength="1">
            <button onclick="decrement('highInput')">↓</button>
            <button onclick="increment('highInput')">↑</button>
        </label>
        <br><br>

        <button onclick="startGame()">開始遊戲</button>
    `;

    // 允許直接手動輸入時檢查合法字元
    setupCharInput('lowInput');
    setupCharInput('highInput');
}

/* ========= 開始遊戲 ========= */
function startGame() {
    // 讀取資料
    state.playerName = document.getElementById("nameInput").value;
    state.digit = Number(document.getElementById("digitInput").value);
    state.useRepeat = document.getElementById("useRepeat").checked; // 修正 id 與 state 名稱

    // 先讀上下限
    let low = document.getElementById("lowInput").value.toLowerCase();
    let high = document.getElementById("highInput").value.toLowerCase();

    // 檢查是否在 allowedChars
    if (!allowedChars.includes(low) || !allowedChars.includes(high)) {
        alert("上下限只能輸入 0~z 的字元！");
        return;
    }

    // 檢查順序
    if (allowedChars.indexOf(high) < allowedChars.indexOf(low)) {
        alert("最高位不能小於最低位，請重新輸入！");
        return;
    }

    state.low = low;
    state.high = high;

    renderGamePage();
}

/* ========= 畫面 2 ========= */
function renderGamePage() {
    document.getElementById("app").innerHTML = `
        <h2>遊戲畫面</h2>

        <p>玩家：${state.playerName}</p>
        <p>遊戲位數：${state.digit}</p>
        <p>允許重複狀態：<span id="RepeatStatus"></span></p>
        <p>範圍：${state.low} ~ ${state.high}</p>

        <input id="gameInput" placeholder="隨便輸入（示範）">
        <button onclick="fakeCheck()">送出</button>

        <p id="gameMessage"></p>
        <p id="testnumber"></p>

        <br>
        <button onclick="renderResultPage()">直接到結果畫面</button>
        <button onclick="renderStartPage()">回開始畫面</button>
    `;

    showRepeatStatus();
    showTestNumber();
}

/* ========= 顯示允許重複狀態 ========= */
function showRepeatStatus() {
    const el = document.getElementById("RepeatStatus"); // 修正 id
    el.innerText = state.useRepeat ? "已允許" : "不允許";
}

/* ========= 顯示測試亂數 ========= */
function showTestNumber() {
    let a = RandomNumberNoRepeat(state.digit, state.high, state.low);
    let b = RandomNumberRepeat(state.digit, state.high, state.low);
    document.getElementById("testnumber").innerText = `不重複：${a}，重複：${b}`;
}

/* ========= 模擬檢查輸入 ========= */
function fakeCheck() {
    state.fakeInput = document.getElementById("gameInput").value;
    document.getElementById("gameMessage").innerText =
    `你剛剛輸入了：${state.fakeInput} 是 ${checkA("1234", state.fakeInput)}A${checkB("1234", state.fakeInput)}B，字母a呈現出 ${CharToInt("a")} 而數字5呈現 ${CharToInt("5")}`;
}

/* ========= 畫面 3 ========= */
function renderResultPage() {
    document.getElementById("app").innerHTML = `
        <h2>結果畫面</h2>

        <p>玩家：${state.playerName}</p>
        <p>遊戲位數：${state.digit}</p>
        <p>最後一次輸入：${state.fakeInput}</p>
        <p>允許重複：${state.useRepeat ? "是" : "否"}</p>
        <p>範圍：${state.low} ~ ${state.high}</p>

        <button onclick="renderStartPage()">重新開始</button>
    `;
}

/* ========= 上下限按鈕 ========= */
function increment(inputId) {
    const el = document.getElementById(inputId);
    let idx = allowedChars.indexOf(el.value.toLowerCase());
    idx = (idx + 1) % allowedChars.length;
    el.value = allowedChars[idx];
}

function decrement(inputId) {
    const el = document.getElementById(inputId);
    let idx = allowedChars.indexOf(el.value.toLowerCase());
    idx = (idx - 1 + allowedChars.length) % allowedChars.length;
    el.value = allowedChars[idx];
}

/* ========= 允許直接輸入但檢查合法字元 ========= */
function setupCharInput(inputId) {
    const el = document.getElementById(inputId);
    el.addEventListener("input", () => {
        let val = el.value.toLowerCase();
        if (val.length > 1) val = val.slice(-1); // 只取最後一個字
        if (!allowedChars.includes(val)) val = ""; // 非法清空
        el.value = val;
    });
}

/* ========= 亂數產生函式 ========= */
function RandomNumberNoRepeat(digit, max, min) {
    const start = allowedChars.indexOf(min);
    const end = allowedChars.indexOf(max);

    if (start === -1 || end === -1 || start > end) {
        alert("亂數範圍錯誤");
        return "";
    }

    if (digit > end - start + 1) {
        alert("位數超過可用字元數");
        return "";
    }

    let pool = allowedChars.slice(start, end + 1).split("");
    let result = "";

    for (let i = 0; i < digit; i++) {
        const idx = Math.floor(Math.random() * pool.length);
        result += pool[idx];
        pool.splice(idx, 1); // 移除，避免重複
    }

    return result;
}

function RandomNumberRepeat(digit, max, min) {
    const start = allowedChars.indexOf(min);
    const end = allowedChars.indexOf(max);

    if (start === -1 || end === -1 || start > end) {
        alert("亂數範圍錯誤");
        return "";
    }

    let result = "";

    for (let i = 0; i < digit; i++) {
        const idx = start + Math.floor(Math.random() * (end - start + 1));
        result += allowedChars[idx];
    }

    return result;
}

/* ========= 字元變成數字 ========= */
function CharToInt(a){
    return allowedChars.indexOf(a);
}
/* ========= 出現幾次 ========= */
function countChar(str, char) {
    let count = 0;
    for (let i = 0; i < str.length; i++) {
        if (str[i] === char) count++;
    }
    return count;
}
function returnMin(a, b) {
    return a < b ? a : b;
}



/* ========= 檢查 A ========= */
function checkA(answer, guess) {
    if (answer.length !== guess.length) {
        alert("兩者長度不同");
        return;
    }

    let A = 0;

    for (let i = 0; i < answer.length; i++) {
        if (answer[i] === guess[i]) {
            A++;
        }
    }

    return A;
}
function checkB(answer, guess) {
    if (answer.length !== guess.length) {
        alert("兩者長度不同");
        return;
    }

    let A = checkA(answer, guess);
    let B = 0;

    for (let i = CharToInt(state.low); i <= CharToInt(state.high); i++) {
    B += returnMin(countChar(answer, allowedChars[i]), countChar(guess, allowedChars[i]));
    }

    B-=A;
    return B;
}  
</script>

</body>
</html>
