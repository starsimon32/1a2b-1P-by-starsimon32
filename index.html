<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>1A2B 完整教學13 SPA（修正版）</title>
<style>
button { margin: 2px; }
input { width: 60px; text-align: center; }
</style>
</head>

<body onload="renderStartPage()">

<div id="app"></div>

<script>
/* ========= 全域狀態 ========= */
const state = {
    playerName: "",
    digit: 4,
    useRepeat: true,
    low: "0",
    high: "9",
    answer: "",
    guesscount: 0,
    haveGuessed: false,
    history: []
};

/* ========= 可用字元 ========= */
const allowedChars = "0123456789abcdefghijklmnopqrstuvwxyz";

/* ========= 輸入檢查 ========= */
function alert_guesswrong(input){
    if(input.length !== state.digit){
        alert("輸入長度錯誤！");
        return false;
    }

    for(let i = 0; i < input.length; i++){
        let idx = CharToInt(input[i]);

        if(idx === -1){
            alert(`第 ${i + 1} 位含有非法字元`);
            return false;
        }

        if(idx < CharToInt(state.low) || idx > CharToInt(state.high)){
            alert(`第 ${i + 1} 位超出限制範圍`);
            return false;
        }
    }

    if(!state.useRepeat){
        let set = new Set(input);
        if(set.size !== input.length){
            alert("目前設定不允許重複字元");
            return false;
        }
    }

    return true;
}

/* ========= 開始畫面 ========= */
function renderStartPage(){
    document.getElementById("app").innerHTML = `
        <h2>開始畫面</h2>

        玩家名稱：
        <input id="nameInput" value="${state.playerName}"><br><br>

        位數：
        <input id="digitInput" type="number" value="${state.digit}"><br><br>

        允許重複：
        <input type="checkbox" id="useRepeat" ${state.useRepeat ? "checked" : ""}><br><br>

        最低位：
        <input id="lowInput" value="${state.low}" maxlength="1">
        <button onclick="decrement('lowInput')">↓</button>
        <button onclick="increment('lowInput')">↑</button><br><br>

        最高位：
        <input id="highInput" value="${state.high}" maxlength="1">
        <button onclick="decrement('highInput')">↓</button>
        <button onclick="increment('highInput')">↑</button><br><br>

        <button onclick="computerIsanswer_alerts()">開始猜電腦</button>
    `;

    setupCharInput("lowInput");
    setupCharInput("highInput");

    state.history = [];
}

/* ========= 讀取設定 ========= */
function readSettings(){
    state.playerName = document.getElementById("nameInput").value;
    state.digit = Number(document.getElementById("digitInput").value);
    state.useRepeat = document.getElementById("useRepeat").checked;

    let low = document.getElementById("lowInput").value.toLowerCase();
    let high = document.getElementById("highInput").value.toLowerCase();

    if(!allowedChars.includes(low) || !allowedChars.includes(high)){
        alert("上下限只能是 0~z");
        return false;
    }

    if(CharToInt(high) < CharToInt(low)){
        alert("最高位不能小於最低位");
        return false;
    }

    if(!state.useRepeat && (CharToInt(high) - CharToInt(low) + 1) < state.digit){
        alert("字元數不足，必定重複");
        return false;
    }

    state.low = low;
    state.high = high;
    return true;
}

/* ========= 電腦出題 ========= */
function computerIsanswer_alerts(){
    if(!readSettings()) return;

    state.answer = state.useRepeat ? RandomNumberRepeat() : RandomNumberNoRepeat();
    state.guesscount = 0;
    state.haveGuessed = false;
    state.history = [];

    renderComputerGame();
}

/* ========= 猜電腦畫面 ========= */
function renderComputerGame(){
    document.getElementById("app").innerHTML = `
        <h2>猜電腦題目</h2>

        <p>玩家：${state.playerName}</p>
        <p>第 ${state.guesscount + 1} 次猜測</p>

        <input id="guessInput">
        <button onclick="f_guess()">猜</button>
        <button onclick="f_guessnext()">下一次</button>
        <button onclick="renderStartPage()">回開始</button>

        <p id="result"></p>
        <div id="history"></div>
    `;

    showHistory();
}

/* ========= 猜 ========= */
function f_guess(){
    if(state.haveGuessed){
        alert("這一回合已猜過");
        return;
    }

    let input = document.getElementById("guessInput").value;

    if(!alert_guesswrong(input)) return;

    let A = checkA(state.answer, input);
    let B = checkB(state.answer, input);

    state.haveGuessed = true;
    state.history.push({guess: input, A, B});

    document.getElementById("result").innerText =
        `${input} → ${A}A${B}B`;

    showHistory();
}

/* ========= 下一次 ========= */
function f_guessnext(){
    if(!state.haveGuessed){
        alert("請先猜一次");
        return;
    }
    state.haveGuessed = false;
    state.guesscount++;
    renderComputerGame();
}

/* ========= 顯示歷史 ========= */
function showHistory(){
    let html = "<h3>歷史紀錄</h3>";
    for(let i = 0; i < state.history.length; i++){
        let h = state.history[i];
        html += `<p>${i + 1}. ${h.guess} → ${h.A}A${h.B}B</p>`;
    }
    document.getElementById("history").innerHTML = html;
}

/* ========= 輔助 ========= */
function increment(id){
    let el = document.getElementById(id);
    let i = allowedChars.indexOf(el.value);
    el.value = allowedChars[(i + 1) % allowedChars.length];
}

function decrement(id){
    let el = document.getElementById(id);
    let i = allowedChars.indexOf(el.value);
    el.value = allowedChars[(i - 1 + allowedChars.length) % allowedChars.length];
}

function setupCharInput(id){
    let el = document.getElementById(id);
    el.addEventListener("input", () => {
        let v = el.value.toLowerCase();
        if(!allowedChars.includes(v)) el.value = "";
    });
}

/* ========= 亂數 ========= */
function RandomNumberNoRepeat(){
    let start = CharToInt(state.low);
    let end = CharToInt(state.high);
    let pool = allowedChars.slice(start, end + 1).split("");
    let r = "";
    for(let i = 0; i < state.digit; i++){
        let idx = Math.floor(Math.random() * pool.length);
        r += pool[idx];
        pool.splice(idx, 1);
    }
    return r;
}

function RandomNumberRepeat(){
    let start = CharToInt(state.low);
    let end = CharToInt(state.high);
    let r = "";
    for(let i = 0; i < state.digit; i++){
        r += allowedChars[start + Math.floor(Math.random() * (end - start + 1))];
    }
    return r;
}

/* ========= 核心判斷 ========= */
function CharToInt(c){ return allowedChars.indexOf(c); }

function checkA(a, g){
    let A = 0;
    for(let i = 0; i < a.length; i++){
        if(a[i] === g[i]) A++;
    }
    return A;
}

function checkB(a, g){
    let B = 0;
    for(let i = CharToInt(state.low); i <= CharToInt(state.high); i++){
        let c = allowedChars[i];
        B += Math.min(countChar(a, c), countChar(g, c));
    }
    return B - checkA(a, g);
}

function countChar(s, c){
    return [...s].filter(x => x === c).length;
}
</script>

</body>
</html>
