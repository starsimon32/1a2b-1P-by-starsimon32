<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>1A2B SPA18 修正版</title>
<style>
button { margin: 4px; }
input { width: 80px; text-align: center; }
</style>
</head>

<body onload="renderStartPage()">
<div id="app"></div>

<script>
/* ========= 狀態 ========= */
const state = {
    playerName: "",
    digit: 4,
    useRepeat: true,
    low: "0",
    high: "9",
    answer: "",
    guesscount: 0,
    haveGuessed: false,
    history: []
};

const allowedChars = "0123456789abcdefghijklmnopqrstuvwxyz";

/* ========= 工具 ========= */
function CharToInt(c){ return allowedChars.indexOf(c); }

function checkrepeat(s){
    for(let i=0;i<s.length;i++)
        for(let j=i+1;j<s.length;j++)
            if(s[i] === s[j]) return false;
    return true;
}

function charadd1(c){
    let a = CharToInt(c);
    return allowedChars[
        a === CharToInt(state.high)
        ? CharToInt(state.low)
        : a + 1
    ];
}

function stringadd1(s){
    let arr = s.split("");
    arr[arr.length-1] = charadd1(arr[arr.length-1]);
    for(let i=arr.length-1;i>0;i--){
        if(arr[i] === state.low)
            arr[i-1] = charadd1(arr[i-1]);
        else break;
    }
    return arr.join("");
}

/* ========= 畫面 ========= */
function renderStartPage(){
    app.innerHTML = `
        <h2>開始</h2>
        名稱 <input id="nameInput"><br>
        位數 <input id="digitInput" type="number" value="4"><br>
        可重複 <input type="checkbox" id="useRepeat" checked><br>
        最低 <input id="lowInput" value="0"><br>
        最高 <input id="highInput" value="9"><br>
        <button onclick="startGame()">開始</button>
    `;
}

function startGame(){
    state.playerName = nameInput.value;
    state.digit = Number(digitInput.value);
    state.useRepeat = useRepeat.checked;
    state.low = lowInput.value;
    state.high = highInput.value;

    if(!state.useRepeat &&
       CharToInt(state.high)-CharToInt(state.low)+1 < state.digit){
        alert("一定重複");
        return;
    }

    state.answer = state.useRepeat
        ? RandomNumberRepeat()
        : RandomNumberNoRepeat();

    state.history = [];
    state.guesscount = 0;
    state.haveGuessed = false;
    renderGamePage();
}

function renderGamePage(){
    app.innerHTML = `
        <h2>猜數字</h2>
        <div id="historys"></div>
        <input id="guessInput">
        <button onclick="guess()">猜</button>
        <button onclick="nextRound()">下一次</button>
        <p id="result"></p>
    `;
    showHistory();
}

/* ========= 遊戲 ========= */
function guess(){
    if(state.haveGuessed) return;

    let g = guessInput.value;
    if(g.length !== state.digit) return;

    let A = checkA(state.answer, g);
    let B = checkB(state.answer, g);

    state.history.push({guess:g,A,B});
    state.haveGuessed = true;

    result.innerText = `${g} → ${A}A${B}B`;
    showHistory();
}

function nextRound(){
    if(!state.haveGuessed) return;
    state.guesscount++;
    state.haveGuessed = false;
    renderGamePage();
}

/* ========= 歷史 ========= */
function showHistory(){
    let html = "<b>歷史</b><br>";
    if(state.history.length === 0){
        html += "暫無紀錄";
    }else{
        state.history.forEach((h,i)=>{
            html += `第${i+1}次：${h.guess} → ${h.A}A${h.B}B<br>`;
        });
    }
    historys.innerHTML = html;
}

/* ========= 判斷 ========= */
function checkA(a,g){
    return [...a].filter((c,i)=>c===g[i]).length;
}

function checkB(a,g){
    let B=0;
    for(let i=CharToInt(state.low);i<=CharToInt(state.high);i++){
        let c = allowedChars[i];
        B += Math.min(
            [...a].filter(x=>x===c).length,
            [...g].filter(x=>x===c).length
        );
    }
    return B-checkA(a,g);
}

/* ========= 亂數 ========= */
function RandomNumberRepeat(){
    let r="", s=CharToInt(state.low), e=CharToInt(state.high);
    for(let i=0;i<state.digit;i++)
        r+=allowedChars[s+Math.floor(Math.random()*(e-s+1))];
    return r;
}

function RandomNumberNoRepeat(){
    let pool = allowedChars
        .slice(CharToInt(state.low),CharToInt(state.high)+1)
        .split("");
    let r="";
    for(let i=0;i<state.digit;i++){
        let idx=Math.floor(Math.random()*pool.length);
        r+=pool.splice(idx,1)[0];
    }
    return r;
}
</script>
</body>
</html>
