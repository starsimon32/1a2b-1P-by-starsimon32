<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>1A2B SPA å®Œæ•´å¯åŸ·è¡Œç‰ˆ20ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
<style>
button { margin: 4px; }
input { width: 80px; text-align: center; }
</style>
</head>

<body onload="renderStartPage()">

<div id="app"></div>

<script>
/* ========= å…¨åŸŸç‹€æ…‹ ========= */
const state = {
    playerName: "",
    digit: 4,
    useRepeat: true,
    low: "0",
    high: "9",
    answer: "",
    guesscount: 0,
    haveGuessed: false,
    history: []
};

const allowedChars = "0123456789abcdefghijklmnopqrstuvwxyz";

/* ========= å·¥å…· ========= */
function checkrepeat(s){
    for(let i=0;i<s.length;i++){
        for(let j=i+1;j<s.length;j++){
            if(s[i]===s[j]){
                return false;
            }
        }
    }
    return true;
}
function charadd1(c){
    let a=CharToInt(c);
    if(a===CharToInt(state.high)){
        a=CharToInt(state.low)
    }
    else{
        a++;
    }
    return allowedChars[a];
}
function stringadd1(s){
    let a=s;
    a[a.length-1]=charadd1(a[a.length-1]);
    for(let i=a.length-1;i>0;i--){
        if(a[i]===state.low){
        a[i-1]=charadd1(a[i-1]);
        }
        else{
            break;
        }
        
    }
    return a;
    
}
function CharToInt(c){ return allowedChars.indexOf(c); }

function increment(id){
    const el = document.getElementById(id);
    el.value = allowedChars[(CharToInt(el.value) + 1) % allowedChars.length];
}
function decrement(id){
    const el = document.getElementById(id);
    el.value = allowedChars[(CharToInt(el.value) - 1 + allowedChars.length) % allowedChars.length];
}
function setupCharInput(id){
    const el = document.getElementById(id);
    el.addEventListener("input", () => {
        el.value = el.value.toLowerCase();
        if(!allowedChars.includes(el.value)) el.value = "";
    });
}

/* ========= é–‹å§‹ç•«é¢ ========= */
function renderStartPage(){
    document.getElementById("app").innerHTML = `
        <h2>é–‹å§‹ç•«é¢</h2>

        ç©å®¶åç¨±ï¼š
        <input id="nameInput" value="${state.playerName}"><br><br>

        ä½æ•¸ï¼š
        <input id="digitInput" type="number" value="${state.digit}"><br><br>

        å…è¨±é‡è¤‡ï¼š
        <input type="checkbox" id="useRepeat" ${state.useRepeat ? "checked" : ""}><br><br>

        æœ€ä½ä½ï¼š
        <input id="lowInput" value="${state.low}" maxlength="1">
        <button onclick="decrement('lowInput')">â†“</button>
        <button onclick="increment('lowInput')">â†‘</button><br><br>

        æœ€é«˜ä½ï¼š
        <input id="highInput" value="${state.high}" maxlength="1">
        <button onclick="decrement('highInput')">â†“</button>
        <button onclick="increment('highInput')">â†‘</button><br><br>

        <button onclick="startGame()">é–‹å§‹çŒœé›»è…¦</button>
    `;
    setupCharInput("lowInput");
    setupCharInput("highInput");
}

/* ========= è®€å–è¨­å®š ========= */
function startGame(){
    state.playerName = nameInput.value;
    state.digit = Number(digitInput.value);
    state.useRepeat = useRepeat.checked;

    let low = lowInput.value;
    let high = highInput.value;

    if(CharToInt(high) < CharToInt(low)){
        alert("æœ€é«˜ä½ä¸èƒ½å°æ–¼æœ€ä½ä½");
        return;
    }

    if(!state.useRepeat && (CharToInt(high) - CharToInt(low) + 1) < state.digit){
        alert("å­—å…ƒæ•¸ä¸è¶³ï¼Œå¿…å®šé‡è¤‡");
        return;
    }

    state.low = low;
    state.high = high;
    state.answer = state.useRepeat ? RandomNumberRepeat() : RandomNumberNoRepeat();
    state.history = [];
    state.guesscount = 0;
    state.haveGuessed = false;

    renderGamePage();
}

/* ========= éŠæˆ²ç•«é¢ ========= */
function renderGamePage(){
    document.getElementById("app").innerHTML = `
        <h2>çŒœé›»è…¦æ•¸å­—</h2>
        <p id="historys"></p>

        <p>ç©å®¶ï¼š${state.playerName}</p>
        <p>ç¬¬ ${state.guesscount + 1} æ¬¡çŒœæ¸¬</p>

        <input id="guessInput">
        <button onclick="guess()">çŒœ</button>
        <button onclick="nextRound()">ä¸‹ä¸€æ¬¡</button>
        <button onclick="giveHint()">æç¤º</button>
        <button onclick="giveHelp()">å¹«åŠ©</button>
        <button onclick="showLeft()">é¡¯ç¤ºå‰©é¤˜è§£æ•¸é‡</button>
        <button onclick="giveUp()">æ”¾æ£„</button>
        <button onclick="renderStartPage()">å›é–‹å§‹</button>

        <p id="result"></p>
        <p id="hint"></p>
        <p id="help"></p>
        <p id="left"></p>
    `;
    showHistory();
}

/* ========= çŒœ ========= */
function guess(){
    if(state.haveGuessed){
        alert("æœ¬å›åˆå·²çŒœ");
        return;
    }

    let input = guessInput.value;
    if(!validGuess(input)) return;

    let A = checkA(state.answer, input);
    let B = checkB(state.answer, input);

    state.history.push({ guess: input, A, B });
    state.haveGuessed = true;

    result.innerText = `${input} â†’ ${A}A${B}B`;
    showHistory();

    if(A === state.digit){
        victoryPage();
    }
}

/* ========= ä¸‹ä¸€å›åˆ ========= */
function nextRound(){
    if(!state.haveGuessed){
        alert("è«‹å…ˆçŒœä¸€æ¬¡");
        return;
    }
    state.guesscount++;
    state.haveGuessed = false;
    renderGamePage();
}

/* ========= æç¤º ========= */
function correctguess(s){
    for(let i = 0; i < state.history.length; i++){
        let h = state.history[i];
        if(checkA(h.guess,s) !== h.A ||
           checkB(h.guess,s) !== h.B){
            return i ;
            break;
        }
    }
    return -1;
}
function giveHint(){
    if(state.history.length === 0){
        alert("ç¬¬ä¸€æ¬¡æ²’æœ‰æç¤º");
        return;
    }

    let input = guessInput.value;
    if(!validGuess(input)) return;
    let a=correctguess(input);
    let msg="";
    if(a===-1){
        let msg = "æ­¤çŒœæ¸¬èˆ‡æ‰€æœ‰æ­·å²ç´€éŒ„ç›¸å®¹";
    }
    else{
        msg = `èˆ‡ç¬¬ ${a} æ¬¡çŒœæ¸¬çŸ›ç›¾`;
    }
    hint.innerText = msg;
}
function giveHelp(){
    if(state.useRepeat===true){
        let s=RandomNumberRepeat();      
        while(true){
            if(correctguess(s)===-1){
                break;
            }
            s=stringadd1(s);
        }
    }
    if(state.userepeat===false){
        let s=RandomNumberNoRepeat();      
        while(true){
            if(checkrepeat(s)===false){
                s=function stringadd1(s);
                continue;
            }
            if(correctguess(s)===-1){
                break;
            }
            s=function stringadd1(s);
        }
    }
    msg=` ${s} æ˜¯ä¸€çµ„è§£`;
    help.innerText = msg;
    
}
function showLeft(){
    if(state.userepeat===true){
        let s=RandomNumberRepeat();
        let count=0;
        let stop=s;
        while(true){
            if(correctguess(s)===-1){
                count++;
            }
            s=function stringadd1(s);
            if(stop===s){
                break;
            }
        }
    }
    if(state.userepeat===false){
        let s=RandomNumberNoRepeat();      
        while(true){
            if(checkrepeat(s)===false){
                s=function stringadd1(s);
                continue;
            }
            if(correctguess(s)===-1){
                count++;
            }
            s=function stringadd1(s);
            if(stop===s){
                break;
            }
        }
    }
    msg=` å‰©ä¸‹${count} çµ„è§£`;
    left.innerText = msg;
    
}


/* ========= çµæœé  ========= */
function victoryPage(){
    document.getElementById("app").innerHTML = `
        <h2>ğŸ‰ æ­å–œçŒœä¸­ï¼</h2>
        <p id="historys"></p>
        <p>ç­”æ¡ˆï¼š${state.answer}</p>
        <button onclick="renderStartPage()">å›é–‹å§‹</button>
    `;
    showHistory();
}

function giveUp(){
    document.getElementById("app").innerHTML = `
        <h2>ğŸ˜¢ æ”¾æ£„äº†</h2>
        <p id="historys"></p>
        <p>ç­”æ¡ˆï¼š${state.answer}</p>
        <button onclick="renderStartPage()">å›é–‹å§‹</button>
    `;
    showHistory();
}

/* ========= æ­·å² ========= */
function showHistory(){
    let html = "<b>æ­·å²ç´€éŒ„</b><br>";
    for(let i = 0; i < state.history.length; i++){
        let h = state.history[i];
        html += `ç¬¬ ${i + 1} æ¬¡ï¼š${h.guess} â†’ ${h.A}A${h.B}B<br>`;
    }
    if(state.guesscount===0){
        html +=`æš«ç„¡ç´€éŒ„`;
    }
    historys.innerHTML = html;
}

/* ========= é©—è­‰ ========= */
function validGuess(input){
    if(input.length !== state.digit){
        alert("è¼¸å…¥é•·åº¦éŒ¯èª¤");
        return false;
    }
    for(let c of input){
        let idx = CharToInt(c);
        if(idx === -1 || idx < CharToInt(state.low) || idx > CharToInt(state.high)){
            alert("å«éæ³•æˆ–è¶…å‡ºç¯„åœå­—å…ƒ");
            return false;
        }
    }
    if(!state.useRepeat && new Set(input).size !== input.length){
        alert("ä¸å…è¨±é‡è¤‡");
        return false;
    }
    return true;
}

/* ========= æ ¸å¿ƒåˆ¤æ–· ========= */
function checkA(a, g){
    let A = 0;
    for(let i = 0; i < a.length; i++)
        if(a[i] === g[i]) A++;
    return A;
}
function checkB(a, g){
    let B = 0;
    for(let i = CharToInt(state.low); i <= CharToInt(state.high); i++){
        let c = allowedChars[i];
        B += Math.min(countChar(a, c), countChar(g, c));
    }
    return B - checkA(a, g);
}
function countChar(s, c){
    return [...s].filter(x => x === c).length;
}

/* ========= äº‚æ•¸ ========= */
function RandomNumberNoRepeat(){
    let pool = allowedChars.slice(CharToInt(state.low), CharToInt(state.high) + 1).split("");
    let r = "";
    for(let i = 0; i < state.digit; i++){
        let idx = Math.floor(Math.random() * pool.length);
        r += pool.splice(idx, 1)[0];
    }
    return r;
}
function RandomNumberRepeat(){
    let r = "";
    let s = CharToInt(state.low), e = CharToInt(state.high);
    for(let i = 0; i < state.digit; i++)
        r += allowedChars[s + Math.floor(Math.random() * (e - s + 1))];
    return r;
}
</script>

</body>
</html>
