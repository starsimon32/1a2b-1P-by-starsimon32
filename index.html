<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>1A2B æ”¹ç‰ˆ40</title>

<style>
#timer {
    position: absolute;
    top: 16px;
    right: 20px;
    font-size: 18px;
    font-weight: bold;
    color: #374151;
}
#app {
    position: relative;
    width: 420px;
    background-color: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

body {
    margin: 0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #f2f2f2;
    font-family: Arial, sans-serif;
}

input { width: 80px; text-align: center; }

.start-title { text-align: center; font-size: 32px; }
.game-title { text-align: center; font-size: 34px; color: #3498db; }
.win-title { text-align: center; font-size: 36px; color: #16a34a; }
.lose-title { text-align: center; font-size: 32px; color: #7f8c8d; }

button {
    margin: 4px;
    padding: 8px 14px;
    font-size: 16px;
    cursor: pointer;
}

.btn-group {
    display: flex;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
}

.main-btn button { background:#3498db; color:white; }
.helper-btn button { background:#95a5a6; color:white; }
.danger-btn button { background:#e74c3c; color:white; }

#result { color:#16a34a; font-weight:bold; }
#hint   { color:#2563eb; }
#help   { color:#9333ea; }
#left   { color:#dc2626; }
</style>
</head>

<body onload="renderStartPage()">
<div id="app"></div>

<script>
/* ========= ç‹€æ…‹ ========= */
const state = {
    playerName:"",
    digit:4,
    useRepeat:false,
    low:"0",
    high:"9",
    answer:"",
    guesscount:0,
    haveGuessed:false,
    answerbyuser:false,
    history:[]
};

const allowedChars="0123456789abcdefghijklmnopqrstuvwxyz";

/* ========= è¨ˆæ™‚ ========= */
let timerId=null;
let startTime=0;

function startTimer(){
    stopTimer();
    startTime=Date.now();
    timerId=setInterval(updateTimer,1000);
}
function stopTimer(){
    if(timerId!==null){
        clearInterval(timerId);
        timerId=null;
    }
}
function getElapsed(){
    return Math.floor((Date.now()-startTime)/1000);
}
function formatTime(sec){
    const m=String(Math.floor(sec/60)).padStart(2,"0");
    const s=String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
}
function updateTimer(){
    const t=document.getElementById("timer");
    if(t) t.innerText=formatTime(getElapsed());
}

/* ========= å·¥å…· ========= */
function CharToInt(c){ return allowedChars.indexOf(c); }
function countChar(s,c){ return [...s].filter(x=>x===c).length; }
function checkrepeat(s){ return new Set(s).size===s.length; }

function charadd1(c){
    let a=CharToInt(c);
    return allowedChars[a===CharToInt(state.high)?CharToInt(state.low):a+1];
}
function stringadd1(s){
    let a=s.split("");
    a[a.length-1]=charadd1(a[a.length-1]);
    for(let i=a.length-1;i>0;i--){
        if(a[i]===state.low) a[i-1]=charadd1(a[i-1]);
        else break;
    }
    return a.join("");
}

/* ========= é–‹å§‹ç•«é¢ ========= */
function renderStartPage(){
    stopTimer();
    state.answerbyuser=false;
    app.innerHTML=`
        <div id="timer">00:00</div>
        <h2 class="start-title">æ­¡è¿ä¾†åˆ° 1A2B</h2>
        ç©å®¶åç¨± <input id="nameInput"><br><br>
        ä½æ•¸ <input id="digitInput" type="number" value="4"><br><br>
        æœ€ä½ä½ <input id="lowInput" value="0"><br><br>
        æœ€é«˜ä½ <input id="highInput" value="9"><br><br>
        å…è¨±é‡è¤‡ <input type="checkbox" id="useRepeat"><br><br>
        <button onclick="startGame()">é›»è…¦å‡ºé¡Œ</button>
        <button onclick="startGame2()">æˆ‘ä¾†å‡ºé¡Œ</button>
    `;
}

/* ========= ä½¿ç”¨è€…å‡ºé¡Œ ========= */
function startGame2(){
    state.playerName=nameInput.value;
    state.digit=+digitInput.value;
    state.low=lowInput.value;
    state.high=highInput.value;
    state.useRepeat=useRepeat.checked;

    state.answerbyuser=true;
    app.innerHTML=`
        <h2 class="start-title">è¼¸å…¥ç­”æ¡ˆ</h2>
        <input id="answerInput"><br><br>
        <button onclick="renderStartPage()">å›é¦–é </button>
        <button onclick="confirmUserAnswer()">å‡ºç™¼</button>
    `;
}

function confirmUserAnswer(){
    const input=answerInput.value;
    if(!validGuess(input)) return;
    state.answer=input;
    startTimer();
    initGame();
}

/* ========= é›»è…¦å‡ºé¡Œ ========= */
function startGame(){
    state.playerName=nameInput.value;
    state.digit=+digitInput.value;
    state.low=lowInput.value;
    state.high=highInput.value;
    state.useRepeat=useRepeat.checked;

    state.answer=state.useRepeat?RandomNumberRepeat():RandomNumberNoRepeat();
    startTimer();
    initGame();
}

function initGame(){
    state.history=[];
    state.guesscount=0;
    state.haveGuessed=false;
    renderGamePage();
}

/* ========= éŠæˆ² ========= */
function renderGamePage(){
    app.innerHTML=`
        <div id="timer"></div>
        <h2 class="game-title">çŒœæ•¸å­—</h2>
        <p>ç©å®¶ï¼š${state.playerName}</p>
        <p id="historys"></p>
        <input id="guessInput">

        <div class="btn-group main-btn">
            <button onclick="guess()">çŒœ</button>
            <button onclick="nextRound()">ä¸‹ä¸€æ¬¡</button>
        </div>
        <div class="btn-group helper-btn">
            <button onclick="giveHint()">æç¤º</button>
            <button onclick="giveHelp()">å¹«åŠ©</button>
            <button onclick="showLeft()">å‰©é¤˜è§£</button>
        </div>
        <div class="btn-group danger-btn">
            <button onclick="giveUp()">æ”¾æ£„</button>
        </div>

        <p id="result"></p>
        <p id="hint"></p>
        <p id="help"></p>
        <p id="left"></p>
    `;
    updateTimer();
    showHistory();
}

function guess(){
    const input=guessInput.value;
    if(!validGuess(input)) return;

    const A=checkA(state.answer,input);
    const B=checkB(state.answer,input);
    state.history.push({guess:input,A,B});
    state.haveGuessed=true;

    result.innerText=`${input} â†’ ${A}A${B}B`;
    showHistory();
    if(A===state.digit) victoryPage();
}

function nextRound(){
    if(!state.haveGuessed) return;
    state.guesscount++;
    state.haveGuessed=false;
    renderGamePage();
}

/* ========= å‹è²  ========= */
function victoryPage(){
    stopTimer();
    const time=formatTime(getElapsed());
    app.innerHTML=`
        <h2 class="win-title">ğŸ‰ æ­å–œçŒœä¸­ï¼</h2>
        <p>èŠ±äº†æ™‚é–“ï¼š${time}</p>
        <p>ç­”æ¡ˆï¼š${state.answer}</p>
        <button onclick="renderStartPage()">å›é–‹å§‹</button>
    `;
}

function giveUp(){
    stopTimer();
    const time=formatTime(getElapsed());
    app.innerHTML=`
        <h2 class="lose-title">ğŸ˜¢ æ”¾æ£„äº†</h2>
        <p>èŠ±äº†æ™‚é–“ï¼š${time}</p>
        <p>ç­”æ¡ˆï¼š${state.answer}</p>
        <button onclick="renderStartPage()">å›é–‹å§‹</button>
    `;
}

/* ========= åˆ¤æ–· ========= */
function validGuess(input){
    if(input.length!==state.digit) return alert("é•·åº¦éŒ¯èª¤"),false;
    if(!state.useRepeat && !checkrepeat(input)) return alert("ä¸å…è¨±é‡è¤‡"),false;
    for(let c of input){
        let i=CharToInt(c);
        if(i<CharToInt(state.low)||i>CharToInt(state.high)) return alert("ç¯„åœéŒ¯èª¤"),false;
    }
    return true;
}
function checkA(a,g){ return [...a].filter((x,i)=>x===g[i]).length; }
function checkB(a,g){
    let B=0;
    for(let i=CharToInt(state.low);i<=CharToInt(state.high);i++){
        let c=allowedChars[i];
        B+=Math.min(countChar(a,c),countChar(g,c));
    }
    return B-checkA(a,g);
}

/* ========= æ­·å² ========= */
function showHistory(){
    let html="<b>æ­·å²ç´€éŒ„</b><br>";
    if(state.history.length===0) html+="æš«ç„¡";
    state.history.forEach((h,i)=>{
        html+=`ç¬¬${i+1}æ¬¡ï¼š${h.guess} â†’ ${h.A}A${h.B}B<br>`;
    });
    historys.innerHTML=html;
}

/* ========= äº‚æ•¸ ========= */
function RandomNumberRepeat(){
    let r="",s=CharToInt(state.low),e=CharToInt(state.high);
    for(let i=0;i<state.digit;i++)
        r+=allowedChars[s+Math.floor(Math.random()*(e-s+1))];
    return r;
}
function RandomNumberNoRepeat(){
    let pool=allowedChars.slice(CharToInt(state.low),CharToInt(state.high)+1).split("");
    let r="";
    for(let i=0;i<state.digit;i++){
        let idx=Math.floor(Math.random()*pool.length);
        r+=pool.splice(idx,1)[0];
    }
    return r;
}
</script>
</body>
</html>
